<!DOCTYPE html>
<head>
<title>Price book app</title>
<script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
<script src="semantic.min.js"></script>
<link href="semantic.min.css" rel="stylesheet"/>
<style>
.priceHeader {
  width: 20em;
}
.dateHeader {
  width: 12em;
}

input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button { 
  -webkit-appearance: none; 
  margin: 0; 
}

input[type=number] {
  -moz-appearance:textfield;
}

/* Limits the entry up to 99.99. */
.price {
  width: 3em;
}

.quantity {
  width: 2em;
}

.forSeparator {
  margin-right: .5em;
  margin-right: .5em;
}
</style>
<!-- TODO: Switch to React-Semantic UI -->
<!-- TODO: Provide my own theme (use lato: http://www.latofonts.com/) -->
<!-- TODO: The header should be sticky to follow the viewport. -->
<!-- TODO: Provide an add button -->
<!-- TODO: Provide a remove button -->
<div class="ui segment">

<div class="ui icon input">
  <i class="search icon"></i>
  <input type="text" placeholder="Search item">
</div>
<table class="ui selectable fixed table">
  <thead>
    <tr>
      <th>Product</th>
      <th>Brand</th>
      <th class="priceHeader">Price</th>
      <th>Price per unit</th>
      <th>Place</th>
      <th class="dateHeader">Date</th>
    </tr>
  </thead>
  <tbody id="productList"></tbody>
</table>

</div>
<script>
'use strict';

class Price {
  constructor(price, quantity, unit) {
    // Convert all input to numbers.
    // This makes equals works as we get numbers
    // from our model but stings from the UI.
    this.price = Number(price);
    this.quantity = Number(quantity);
    this.unit = unit;
  }

  equals(otherPrice) {
    return this.price === otherPrice.price
      && this.quantity === otherPrice.quantity
      && this.unit === otherPrice.unit;
  }

  get pricePerQuantity() {
    return Math.round(100 * this.price / this.quantity) / 100;
  }

  get pricePerQuantityText() {
    // TODO: Stop hardcoding '$'.
    return "$" + this.pricePerQuantity + "/" + this.unit;
  }
}

class Product {
  constructor(name, brand, price, place, date) {
    this.name = name;
    this.brand = brand;
    this.price = price;
    this.place = place;
    this.date = date;
  }
}

function generateDateInputCell(date) {
  return generateSingleInputCell(date, "date");
}

function generateSingleTextInputCell(name) {
  return generateSingleInputCell(name, "text");
}

function generateSingleInputCell(value, type) {
  var td = document.createElement("td");
  var semanticInput = document.createElement("div");
  semanticInput.classList.add("ui");
  semanticInput.classList.add("transparent");
  semanticInput.classList.add("input");
  var input = document.createElement("input");
  input.type = type;
  input.value = value;
  input.addEventListener("change", updateModel);
  semanticInput.appendChild(input);
  td.appendChild(semanticInput);
  return td;
}

function generatePriceAndQuantityCell(price) {
  var td = document.createElement("td");
  var semanticInput = document.createElement("div");
  semanticInput.classList.add("ui");
  semanticInput.classList.add("transparent");
  semanticInput.classList.add("input");
  var currency = document.createElement("span");
  // TODO: Remove this hard-coding.
  currency.appendChild(document.createTextNode("$"));
  semanticInput.appendChild(currency);

  var priceNode = document.createElement("input");
  priceNode.type = "number";
  priceNode.classList.add("price");
  priceNode.pattern = "/^\d+\.?\d*$/";
  priceNode.value = price.price;
  priceNode.addEventListener("keypress", function(e) { if(e.target.value.length==5) e.preventDefault(); });
  priceNode.addEventListener("change", updateModel);
  semanticInput.appendChild(priceNode);

  var forSeparator = document.createElement("span");
  forSeparator.classList.add("forSeparator");
  forSeparator.appendChild(document.createTextNode("for"));
  semanticInput.appendChild(forSeparator);

  var quantity = document.createElement("input");
  quantity.type = "number";
  quantity.value = price.quantity;
  quantity.classList.add("quantity");
  quantity.pattern = "\d+";
  quantity.addEventListener("keypress", function(e) { if(e.target.value.length==3) e.preventDefault(); });
  quantity.addEventListener("change", updateModel);
  semanticInput.appendChild(quantity);

  var unit = document.createElement("input");
  unit.type = "text";
  unit.value = price.unit;
  unit.addEventListener("change", updateModel);
  semanticInput.appendChild(unit);
  td.appendChild(semanticInput);
  return td;
}

function updateModel(e) {
  // Find the enclosing row
  var row = e.target.parentNode;
  while (row.tagName !== "TR") {
    row = row.parentNode;
  }

  const oldName = row.childNodes[0].getElementsByTagName("input")[0].oldName;
  const name = row.childNodes[0].getElementsByTagName("input")[0].value;
  var product = productMap.get(oldName);

  // Always update the brand and the place.
  const brand = row.childNodes[1].getElementsByTagName("input")[0].value;
  const place = row.childNodes[4].getElementsByTagName("input")[0].value;
  product.brand = brand;
  product.place = place;


  // TODO: Support multiple products!
  if (oldName !== name) {
    productMap.delete(oldName);
    product.name = name;
    productMap.set(name, product);
  }

  const priceCell = row.childNodes[2];
  const price = priceCell.getElementsByTagName("input")[0].value;
  const quantity = priceCell.getElementsByTagName("input")[1].value;
  const unit = priceCell.getElementsByTagName("input")[2].value;
  const newPrice = new Price(price, quantity, unit);
  if (!product.price.equals(newPrice)) {
    product.price = newPrice;

    var pricePerQuantityCell = row.childNodes[3];
    var newPricePerQuantityCell = generatePricePerQuantityCell(newPrice);
    row.replaceChild(newPricePerQuantityCell, pricePerQuantityCell);
  }

  // Update the date unless it was updated by the user.
  const dateCell = row.childNodes[5];
  const date = dateCell.getElementsByTagName("input")[0].value;
  var shouldUpdateDate = product.date === date;
  if (shouldUpdateDate) {
    product.date = formatToday();
    const newDateCell = generateDateInputCell(product.date);
    row.replaceChild(newDateCell, dateCell);
  } else {
    product.date = date;
  }
}

function generatePricePerQuantityCell(price) {
  var td = document.createElement("td");
  td.appendChild(document.createTextNode(price.pricePerQuantityText));
  return td;
}

function formatToday() {
  // toISOString returns the time, which we won't be accepted
  // by <input type="date"> so we just isolate the date part.
  return new Date().toISOString().split("T")[0];
}

function populateTable() {
  var tbody = document.getElementsByTagName("tbody")[0];
  var new_tbody = document.createElement("tbody");
  for (var [key, product] of productMap) {
    var row = document.createElement("tr");
    var nameCell = generateSingleTextInputCell(product.name);
    // Save the old name on focus to be able to update the map.
    nameCell.getElementsByTagName("input")[0].addEventListener("focus", function(e) { e.target.oldName = e.target.value; });
    row.appendChild(nameCell);
    row.appendChild(generateSingleTextInputCell(product.brand));
    row.appendChild(generatePriceAndQuantityCell(product.price));
    row.appendChild(generatePricePerQuantityCell(product.price));
    row.appendChild(generateSingleTextInputCell(product.place));
    row.appendChild(generateDateInputCell(product.date));
    new_tbody.appendChild(row);
  }
  tbody.parentNode.replaceChild(new_tbody, tbody);
}

// Products keyed by the product name for easier lookup.
var productMap = new Map();
function populateProductMap() {
  var products = [
    new Product("Pear", "Barlett", new Price(1.89, 1, "pound"), "Safeway", "2019-02-01"),
    new Product("Hummus", "Sabra", new Price(6.99, 17, "oz"), "Lucky's", "2018-12-01"),
  ];
  for (var i = 0; i < products.length; ++i) {
    productMap.set(products[i].name, products[i]);
  }
}

function initializeApp() {
  populateProductMap();
  populateTable();
}
window.addEventListener("load", initializeApp);
</script>
