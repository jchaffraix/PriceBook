<!DOCTYPE html>
<html>
<head>
<title>Price book app</title>
<script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
<script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
<script id="main-page-template" type="text/x-handlebars-template">
<div class="ui segment">

<table class="ui selectable unstackable fixed table">
  <thead>
    <tr>
      <th>Product</th>
      <th>Price</th>
      <th>Place</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody>
{{#each products}}
  <tr item-index={{@index}}>
    <td>
      {{name}} {{#if brand}}({{brand}}){{/if}}
    </td>
    {{generate_best_price this}}
  </tr>
{{/each}}
  </tbody>
</table>
</script>
<script id="item-modal-template" type="text/x-handlebars-template">
<div class="header">
  Edit product
</div>
<div class="content">
  <div class="ui labeled input">
    <div class="ui label">
        Name: 
    </div>
    <input type="text" placeholder={{name}}>
  </div>
  <br>
  <div class="ui labeled input">
    <div class="ui label">
        Brand:
    </div>
    <input type="text" placeholder={{brand}}>
  </div>
  <br>
  <div class="ui labeled input">
    <div class="ui label">
        Quantity: 
    </div>
    <input type="number" placeholder={{quantity}}>
    <select class="ui dropdown">{{generate_options this}}</select>
  </div>
</div>
<div class="actions">
  <div class="ui red basic cancel button">
    <i class="remove icon"></i>
    Cancel
  </div>
  <div class="ui green ok inverted button">
  <i class="checkmark icon"></i>
  Save
  </div>
</div>
</script>
<script>
  // TODO: Dynamically load this.
  // TODO: Should the currency be common in our model? Driven by pref like unit?
  var itemList = [
    { "id": "1234",
      "name": "Pasta",
      "brand": "Barilla",
      "quantity": "16",
      "unit": "oz",
      "purchases": [
        {
          "price": 1.25,
          "currency": "$",
          "date": "2020-03-01 18:20",
          "place": "Sprouts"
        },
        {
          "price": 1.00,
          "currency": "$",
          "date": "2020-01-01 20:22",
          "place": "Lucky's"
        }
      ]
    },
    { "id": "5678",
      "name": "Orange",
      "currency": "$",
      "quantity": "1",
      "unit": "lb",
      "purchases": [
        {
          "price": 3.44,
          "currency": "$",
          "date": "2020-04-01 15:15",
          "place": "Whole Foods"
        }
      ]
    }
  ];
    
    function priceText(escapedCurrency, escapedPrice) {
    // TODO: Handle other currencies (euro is after the price).
    return escapedCurrency + escapedPrice;
  }

  Handlebars.registerHelper("generate_best_price", function(item) {
    // Find the best price.
    bestPurchase = item.purchases[0]
    item.purchases.forEach(function(purchase) {
      if (bestPurchase.price > purchase.price) {
        bestPurchase = purchase;
      }
    });

    var escapedCurrency = Handlebars.escapeExpression(bestPurchase.currency);
    var escapedPrice = Handlebars.escapeExpression(bestPurchase.price);
    var escapedPlace = Handlebars.escapeExpression(bestPurchase.place);
    var escapedDate = Handlebars.escapeExpression(bestPurchase.date);
    return new Handlebars.SafeString("<td>" + priceText(escapedCurrency, escapedPrice) + "</td><td>" + escapedPlace + "</td><td>" + escapedDate + "</td>");
  });

  Handlebars.registerHelper("generate_options", function(item) {
    var options = [];
    // TODO: Load the options.
    for (const option of ["lb", "oz", "unit"]) {
      const selected = item.unit === option;
      var optionStr = "<option ";
      optionStr += selected ? "selected " : "";
      optionStr += "value=\"" + option + "\">" + Handlebars.escapeExpression(option) + "</option>";
      options.push(optionStr);
    }
    return new Handlebars.SafeString(options.join(""));
  });

  window.addEventListener("load", function() {
    var template = Handlebars.compile($("#main-page-template").html());
    $("#list").html(template({ "placeholder": "Search product", "products": itemList}));

    // Install the event listeners.
    $("tr").click(function(e) {
      var itemIndex = e.target.parentElement.getAttribute("item-index");
      var modalTemplate = Handlebars.compile($("#item-modal-template").html());
      $("#modal").html(modalTemplate(itemList[itemIndex]));
      $("#modal").modal('show');
    });

		// Install Semantic UI JS.
  });
</script>
<style>
.ui.label {
  width: 10em;
}
</style>
<body>
<div id="list"></div>
<div id="modal" class="ui modal"></div>
</body>
